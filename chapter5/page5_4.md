# Firewalldサービスの設定
OS7系よりiptablesではなくfirewalldの利用が推奨されています。  
iptablesもインストールされていますが、デフォルトでは無効化されています。  

firewalldの稼働状況確認  

```
# firewall-cmd --state
```

firewalldでは`zone`という単位でセキュリティグループを定義しています。  
セキュリティグループにNICを登録する事でポリシーの定義、管理を簡単に行えるようにしています。  

| zone名 | ex |
| ------- | ---- |
| drop | 着信ネットワークパケットはすべて遮断され、返信されません。送信ネットワーク接続のみが可能です。 |
| block | IPv4 では icmp-host-prohibited メッセージで、IPv6 では icmp6-adm-prohibited メッセージですべての着信ネットワーク接続が拒否されます。システム内で開始されたネットワーク接続のみが可能です。 |
| public | 公開エリア用です。自分のコンピューターを保護するため、ネットワーク上の他のコンピューターを信頼しません。選択された着信接続のみが許可されます。 |
| external | マスカレードを特別にルーター用に有効にした外部ネットワーク上での使用向けです。自分のコンピューターを保護するため、ネットワーク上の他のコンピューターを信頼しません。選択された着信接続のみが許可されます。 |
| dmz | 公開アクセスが可能ではあるものの、内部ネットワークへのアクセスには制限がある非武装地帯にあるコンピューター用。選択された着信接続のみが許可されます。 |
| work | 作業エリア用です。自分のコンピューターを保護するため、ネットワーク上の他のコンピューターをほぼ信頼します。選択された着信接続のみが許可されます。 |
| home | ホームエリア用です。自分のコンピューターを保護するため、ネットワーク上の他のコンピューターをほぼ信頼します。選択された着信接続のみが許可されます。 |
| internal | 内部ネットワーク用です。自分のコンピューターを保護するため、ネットワーク上の他のコンピューターをほぼ信頼します。選択された着信接続のみが許可されます。 |
| trusted | すべてのネットワーク接続が許可されます。 |

LANに接続しているNICがデフォルトでどのzoneに登録されているかを確認。  

```
# firewall-cmd --get-zone-of-interface=${INTERFACE_NAME}
```

アクティブなzoneとNICを一括で表示  

```
# firewall-cmd --get-active-zones
```

デフォルトで利用されるzoneの情報は下記設定ファイルで管理されています。  
コマンドで変更する場合  

```
# firewall-cmd --set-default-zone=public
```

```
# vim /etc/firewalld/firewalld.conf
DefaultZone=public
```

手動で変更した場合はfirewalldを  

```
# firewall-cmd --reload
```

または

```
# firewall-cmd --complete-reload
```

を実行して反映させます。  

firewalldコマンドで操作、変更した内容を永続的にするには、  
`--direct`コマンド(これらは元々一時的なもの)を除いてすべてのコマンドに`--permanent` オプションを追加します。  
こうすると変更が永続的になるだけではなく、変更はファイアウォールのリロード、サービスの再起動、  
もしくはシステムの再起動後にのみ適用されることに注意してください。  
`--permanent`オプションなしで`firewall-cmd` を使って設定すると、  
変更は即座に適用されますが、これが有効なのはファイアウォールがリロードされる、システム再起動、  
またはfirewalldサービスが再起動されるまでになります。  
ファイアウォールのリロード自体は接続を切断しませんが、一時的な変更が破棄されることに注意してください。  

#### ポリシーの登録
zoneにデフォルトでどのようなポリシーが設定されているか確認します。  

```
# firewall-cmd --zone=public --list-all
```

**許可ポートの追加**  

```
# firewall-cmd --zone=public --add-port=80/tcp
```

レンジで登録したい場合は下記のように指定  
`-add-port=5060-5061/udp`  

登録されると一覧が下記のように見えます。  
`ports: 80/tcp`  

**許可サービスの追加**  
ポートやポートレンジをサービスとして登録し、サービスの許可、拒否という管理も行えます。  

```
# firewall-cmd --zone=public --add-service=smtp
```

現在登録されているサービスの確認  
```
# firewall-cmd --get-services
dhcpv6-client ssh
```

登録したサービスを削除したい場合  

`--remove-service=smtp`  


#### リッチルール
サービスやポート単位の許可・拒否ではなく細かく制御したいときに利用できるルールを作成できます。  


#### 操作ロック
他root実行されているアプリケーションからfirewallの設定を変更されたくない場合ロックすることが可能  

ロック状態の確認  

```
# firewall-cmd --query-lockdown
```

ロックの有効化、無効化  

```
# firewall-cmd --lockdown-on
# firewall-cmd --lockdown-off
```
